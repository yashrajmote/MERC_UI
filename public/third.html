<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="icon" href="images/abhitech-mahagenco-combined-logo.png" type="image/png">
    <title>Mahagenco</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div x-data="{ isSidebarOpen: false }" class="max-h-screen flex flex-col">
        <nav class="sticky top-0 left-0 w-full z-50 bg-white">
            <div class="mb-4 flex w-full h-5">
                <img src="images/abhitech-mahagenco-combined-logo.png" alt="Logo" class="h-9 w-auto">
            </div>
            <div class="flex border border-gray-300 w-full h-10">
                <button @click="isSidebarOpen = !isSidebarOpen" class="p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
            </div>
        </nav>
        <main class="flex grid grid-cols-2 grid-flow-row p-3 overflow-y-auto">
            
            <section class="grid grid grid-rows-2">
                <section>
                <div class=" bg-white shadow-md rounded-lg p-2 ">
                    <table class=" min-w-full  rounded-xl">
                        <thead class="border border-b p-3 text-center text-sm font-semibold text-gray-900 capitalize" id="analysisTable">
                              
                        </thead>
                        <tbody class="border border-b text-center p-2" id="analysisBody">
                            
                        </tbody>
                    </table>
                    <div class="mt-2 relative w-3/4 pb-3">
                        <label id="rangeLabel" for="small-range" class="text-center block text-sm font-medium text-gray-900 dark:text-white"></label>
                        <input id="rangeInput" type="range" value="500" min="0" max="1000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <label id="min" class="text-sm text-gray-500 dark:text-gray-400 absolute left-0 -bottom-1"></label>
                        <label id="max" class="text-sm text-gray-500 dark:text-gray-400 absolute right-0 -bottom-1"></label>
                    </div>
                </div>

                <div class="mt-1 bg-white shadow-md rounded-lg p-2 h-full">
                    <table class="border-collapse border border-gray-300 min-w-full  rounded-xl">
                        <thead class="border border-gray-300 p-3 text-center text-sm font-semibold text-gray-900 capitalize" id="secondTable">
                              <th>
                                Perfomance Analytics
                              </th>
                        </thead class="border-collapse border border-gray-300">
                        <tbody class="border border-gray-300 text-left p-5" id="secondBody">
                            
                        </tbody>
                    </table>


                </div>
            </section>
                <div class="mt-1 bg-gray-100 rounded-lg shadow-inner text-gray-700 ">
                    <!-- Row -->
                    <div class="p-4 rounded-lg shadow-lg ">
                        <div id="" class="  overflow-x-auto w-full">
                                    <div class="overflow-hidden border rounded-lg border-gray-300">
                                        <table class=" min-w-full  rounded-xl">
                                            <thead class=" px-1 py-1" id="insightTable">
                                                    <th scope="col" class="border border-gray-300 p-5 text-center px-1 py-1 text-sm leading-6 font-semibold text-gray-900 capitalize"> Failure Modes </th>
                                                    <th scope="col" class="p-5 text-center text-sm leading-6 font-semibold text-gray-900 capitalize"> Action Plan </th>
                                            </thead>
                                            <tbody id="insightTableBody">
                                                
                                            </tbody>
                                        </table>
                                    </div>
                        </div>
                    </div>
                
                </div>
            </section>

            <section class="grid grid-cols-2 grid-rows-2 justify-center">
                <div class=" bg-white shadow-md rounded-lg mt-2 p-2 ">
                    <h2 class="text-lg leading-tight text-center font-semibold text-gray-800 mb-1"></h2>
                    <canvas id="chart1" width="100" height="95"></canvas>
                </div>
                <div class=" bg-white shadow-md rounded-lg mt-2 p-2 ">
                    <h2 class="text-lg leading-tight text-center font-semibold text-gray-800 mb-1"></h2>
                    <canvas id="chart2" width="100" height="95"></canvas>
                </div>
            </section>

        
            
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const storedData = localStorage.getItem('insightData');
        const reportData = JSON.parse(localStorage.getItem('reportData'));

        const parsedValues = reportData.parsedValues || {}; 
        const afterCalculations = reportData.afterCalculations || {}; 
        const ROEValues = reportData.ROEValues || {};
        const gainValues = reportData.gainValues || {};

        if (storedData) {
            const parsedData = JSON.parse(storedData);
            console.log(parsedData)
            populateTable([parsedData]);
            populateAnalysisTable([parsedData], parsedValues, afterCalculations, ROEValues, gainValues);
            populateGraphs([parsedData])
            updateRangeLabels([parsedData])
        }
    });

        function populateTable(data) {
            const tableBody = document.querySelector('#insightTableBody');
    
            data.forEach(item => {
                item.data.forEach(mode => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${mode.mode}</td>
                        <td>${mode.sourceSheet}</td>
                        <td>
                            <ul>
                                ${mode.actionPlan.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </td>
                    `;
    
                    tableBody.appendChild(row);
                });
            });
        }

        function populateAnalysisTable(data, newparsedValues, newafterCalculations, newROEValues, gainValues) {

            const { gainMTBF, gainRampRate, gainPeakAVF, gainFGMO, gainAPC, gainSFOC, gainTL, gainNSHR, gainAVF } = gainValues;    
            const { ROE_RP, converted_ROE_MTBF, converted_ROE_RR, converted_ROE_PAVF } = newROEValues;
            const { ASHR, AAPC, ASFOC } = newafterCalculations;
            const { ATL, APAVF, NAVF, NSHR, NAPC, NSFOC, NTL } = newparsedValues; 

            const normGainLoss = gainAPC + gainSFOC + gainTL + gainNSHR + gainAVF ;
            const incentiveGainLoss = gainMTBF + gainRampRate + gainPeakAVF + gainFGMO;
            const netGainLoss = normGainLoss - incentiveGainLoss;

            const AVFDeviation = APAVF - NAVF;
            const SHRDeviation = ASHR - NSHR;
            const APCDeviation = AAPC - NAPC;
            const DOCDeviation = ASFOC - NSFOC;
            const TLDeviation = NTL - ATL;

            const insightData = [
            {
                parameter: "Availability Factor",
                firstTable: [ NAVF, APAVF, AVFDeviation, gainAVF ]
        
            },

            {
                parameter: "Heat Rate",
                firstTable: [ ASHR, NSHR, SHRDeviation, gainNSHR] 
            }, 

            {
                parameter: "Auxiliary Power Consumption",
                firstTable: [ NAVF, APAVF, AVFDeviation, gainAVF ] 
            }, 

            {
                parameter: "Specific Oil Consumption",
                firstTable: [ NAVF, APAVF, AVFDeviation, gainAVF ] 
            }, 

            {
                parameter: "Transit Loss",
                firstTable: [ NAVF, APAVF, AVFDeviation, gainAVF ] 
            }

            ]

            console.log(data);
            const analysisHeader = document.querySelector('#analysisTable');
            const analysisBody = document.querySelector('#analysisBody');
            const secondHeader = document.querySelector('#secondTable');
            const secondBody = document.querySelector('#secondBody');

            const headerRow = document.createElement('tr');
            data.forEach(item => { 
                item.header.forEach(headerText => { 

                    const headers = document.createElement('th');
                    headers.textContent = headerText;
                    headerRow.appendChild(headers)
                });
            });

            analysisHeader.appendChild(headerRow)
            
            const body = document.createElement('tr');
            data.forEach(item => { 
                item.values.forEach(bodyValue => { 
                    const row = document.createElement('td');

                    row.textContent = bodyValue;
                    body.appendChild(row);
                });
            });

            analysisBody.appendChild(body)

            data.forEach(item => {
                const { secondTable, secondValues } = item; // Destructure the arrays

                // Loop through the secondTable and secondValues
                for (let i = 0; i < secondTable.length; i++) {
                    const secondRow = document.createElement('tr'); // Create a new row
            
                    const cell1 = document.createElement('td'); // Create first cell for secondTable value
                    cell1.textContent = secondTable[i]; // Set the text content to secondTable value
            
                    const cell2 = document.createElement('td'); // Create second cell for secondValues value
                    cell2.textContent = secondValues[i]; // Set the text content to secondValues value
            
                    // Append cells to the row
                    secondRow.appendChild(cell1);
                    secondRow.appendChild(cell2);
            
                    // Append the row to the table body
                    secondBody.appendChild(secondRow);
                }
            });

        }

        function populateGraphs(data) {
            console.log(data);
            const ctx = document.getElementById(`chart1`).getContext('2d');
            const ctx1 = document.getElementById(`chart2`).getContext('2d');

        
            data.forEach(item => {
                if (item.parameter === "Availability Factor") {
        
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Avg AVF achieved', 'AVF achieved in HDS', 'AVF achieved in LDS'], 
                            datasets: [{
                                label: 'AVF ', 
                                data: item.graphValues1,
                                backgroundColor: ['#FF0000', '#00FF00', '#FF0000'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            responsive: true,
                            scales: {
                                x: { // X-axis config
                                    beginAtZero: true
                                },
                                y: { // Y-axis config
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                if (item.parameter === "Heat Rate") {
        
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Normative SHR (kcal/kwh)', 'Achieved SHR (kcal/kwh)'],
                            datasets: [{
                                label: 'AVF ', 
                                data: item.graphValues1, 
                                backgroundColor: ['#FF0000', '#00FF00'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            responsive: true,
                            scales: {
                                x: { 
                                    beginAtZero: true
                                },
                                y: { 
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['Normative Rd./Mkcal', 'Effective Rd/Mkcal'], 
                            datasets: [{
                                label: 'SHR ', 
                                data: item.graphValues2, 
                                backgroundColor: ['#FF4C4C', '#00CC66'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            responsive: true,
                            scales: {
                                x: {
                                    beginAtZero: true
                                },
                                y: { 
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                if (item.parameter === "Auxiliary Power Consumption") {
        
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Normative APC (%)', 'Achieved APC (%)'],
                            datasets: [{
                                label: 'APC ', 
                                data: item.graphValues1, 
                                backgroundColor: ['#FF0000', '#00FF00'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            responsive: true,
                            scales: {
                                x: { 
                                    beginAtZero: true
                                },
                                y: { 
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    new Chart(ctx1, {
                        type: 'pie',
                        data: {
                            labels: ['Loss due to external Factors (%)', 'Loss due to O&M factors (%)'], 
                            datasets: [{
                                label: 'SHR ', 
                                data: item.graphValues2, 
                                backgroundColor: ['#FF4C4C', '#00CC66'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true, 
                            plugins: {
                                legend: {
                                }
                        }
                    }
                    });
                }

                if (item.parameter === "Specific Oil Consumption") {
        
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Normative SOC (ml/kwh)', 'Achieved SOC (ml/kwh)'],
                            datasets: [{
                                label: 'SOC ', 
                                data: item.graphValues1, 
                                backgroundColor: ['#FF0000', '#00FF00'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            responsive: true,
                            scales: {
                                x: { 
                                    beginAtZero: true
                                },
                                y: { 
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['Unit Startup', 'Set Stabilization', 'Flame Stability'], 
                            datasets: [{
                                label: 'SOC ', 
                                data: item.graphValues2, 
                                backgroundColor: ['#FF4C4C', '#00CC66', '#FF4C4C'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false 
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        position: 'top',
                                    },
                                    stacked: true 
                                },
                                y: {
                                    title: {
                                        display: true,
                                    }
                                }
                            }
                        }
                    });
                }

                if (item.parameter === "Transit Loss") {
        
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Avg AVF achieved', 'AVF achieved in HDS', 'AVF achieved in LDS'], 
                            datasets: [{
                                label: 'AVF ', 
                                data: item.graphValues1,
                                backgroundColor: ['#FF0000', '#00FF00', '#FF0000'], 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            responsive: true,
                            scales: {
                                x: { // X-axis config
                                    beginAtZero: true
                                },
                                y: { // Y-axis config
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

            });
        }
        
        function updateRangeLabels(data) {
            data.forEach(item => {
                label = item.parameter;
            });            
            const rangeInput = document.getElementById('rangeInput');
            const rangeLabel = document.getElementById('rangeLabel');
            const minLabel = document.getElementById('min');
            const maxLabel = document.getElementById('max');        
        
            // Define the range and labels for each parameter
            const parameterRanges = {
                "Availability Factor": { min: 0, max: 100, step: 1, unit: "%" },
                "Heat Rate": { min: 1500, max: 3000, step: 50, unit: "kcal/kWh" },
                "Auxiliary Power Consumption": { min: 0, max: 15, step: 0.5, unit: "%" },
                "Specific Oil Consumption": { min: 0, max: 2, step: 0.1, unit: "ml/kWh" },
                "Transit Loss": { min: 0, max: 10, step: 0.5, unit: "%" }
            };
        
            // Check if the parameter exists in the range configuration
            if (parameterRanges[label]) {

                const { min, max, step, unit } = parameterRanges[label];
        
                // Update the range input attributes
                rangeInput.min = min;
                rangeInput.max = max;
                rangeInput.step = step;
                rangeInput.value = min; // Reset to min value

                // Update the label
                rangeLabel.textContent = `${label} (${unit})`;
                console.log(rangeLabel)
        
                // Update the min and max text below the slider
                minLabel.textContent = `Min (${min}${unit})`;
                maxLabel.textContent = `Max (${max}${unit})`;
            }
        }
        
        
    </script>
    <script src="js/scripts.js"></script>
    </body>
    </html>
        